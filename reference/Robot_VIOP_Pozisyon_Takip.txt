//************* ROBOT: GERÃ‡EK VÄ°OP POZÄ°SYON TAKÄ°P & TELEGRAM BÄ°LDÄ°RÄ°M V3 *************
// KURULUM:
// 1. Bu kodu Robot olarak kaydedin.
// 2. iDeal Ana MenÃ¼ -> PortfÃ¶y -> Robot (veya Sanal PortfÃ¶y) penceresini aÃ§Ä±n.
// 3. Robotu seÃ§in ve periyodu "1 Dakika" (veya daha sÄ±k) olarak ayarlayÄ±n.
// 4. "BaÅŸlat" butonuna basÄ±n.

// AYARLAR
System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12;
var ApiToken = "8581068218:AAEcQ7_-Bl38JeIs1ifpvZusm4QXBz_uFBY";
var ChatIdMain = "-1003352024161";
var RaporGondermeAraligiDakika = 15;

// Dosya YollarÄ±
string DosyaDebug = "C:\\iDeal\\VIOP_Pozisyon_Debug.txt";

// Helper: Dosyaya GÃ¼venli Yazma
Action<string, string, bool> DosyayaYaz = (dosya, icerik, append) => {
    for (int i = 0; i < 5; i++)
    {
        try
        {
            if (append) System.IO.File.AppendAllText(dosya, icerik);
            else System.IO.File.WriteAllText(dosya, icerik);
            break;
        }
        catch { System.Threading.Thread.Sleep(50); }
    }
};

var Now = DateTime.Now;

// Ã–NEMLÄ°: Robot Ã§ok sÄ±k Ã§alÄ±ÅŸÄ±yorsa throttle uygula
var KeyLastRun = "Viop_LastRun";
var LastRunObj = Sistem.NesneGetir(KeyLastRun);
DateTime LastRun = LastRunObj == null ? DateTime.MinValue : (DateTime)LastRunObj;

// 5 saniyeden daha kÄ±sa sÃ¼rede tekrar Ã§alÄ±ÅŸmasÄ±nÄ± engelle
if ((Now - LastRun).TotalSeconds < 5)
{
    return null;
}
Sistem.NesneKaydet(KeyLastRun, Now);

// --- VIOP HESAP BÄ°LGÄ°LERÄ°NÄ° OKU ---
var ViopHesap = Sistem.ViopHesapOku();

if (ViopHesap == null)
{
    return null; // Sessizce Ã§Ä±k, log spam yapma
}

// --- HESAP BÄ°LGÄ°LERÄ° ---
var ToplamTeminat = ViopHesap.TeminatToplam;
var KullanilabilirTeminat = ViopHesap.TeminatKullanilabilir;
var CekilebilirTeminat = ViopHesap.TeminatCekilebilir;

// --- GERÃ‡EKLEÅEN EMÄ°R BÄ°LDÄ°RÄ°MÄ° (Dakikada Bir Kontrol) ---
var KeyLastOrderCheck = "Viop_LastOrderCheck";
var LastOrderCheckObj = Sistem.NesneGetir(KeyLastOrderCheck);
DateTime LastOrderCheck = LastOrderCheckObj == null ? DateTime.MinValue : (DateTime)LastOrderCheckObj;

// En az 1 dakika geÃ§tiyse
if ((Now - LastOrderCheck).TotalSeconds >= 60)
{
    Sistem.NesneKaydet(KeyLastOrderCheck, Now);
    DosyayaYaz(DosyaDebug, Now + " DEBUG: Emir kontrolÃ¼ yapÄ±lÄ±yor...\r\n", true);

    try
    {
        var GerceklesenList = ViopHesap.GerceklesenEmirler;

        if (GerceklesenList != null && GerceklesenList.Count > 0)
        {
            DosyayaYaz(DosyaDebug, Now + " INFO: " + GerceklesenList.Count + " adet gerÃ§ekleÅŸen emir bulundu.\r\n", true);

            // Cache: String olarak saklÄ±yoruz
            var KeyBildirilenEmirler = "Viop_Bildirilen_Emirler_Str_V3";
            var BildirilenEmirlerStr = Sistem.NesneGetir(KeyBildirilenEmirler) as string;
            if (BildirilenEmirlerStr == null) BildirilenEmirlerStr = "";

            bool yeniBildirimVar = false;

            for (int i = 0; i < GerceklesenList.Count; i++)
            {
                var emir = GerceklesenList[i];
                
                // EmirNo unique ID olarak kullanÄ±lÄ±r
                string emirId = emir.OrderNo.ToString();
                
                // Delimiter ile gÃ¼venli kontrol
                string aramaPattern = "|" + emirId + "|";
                string cacheStr = "|" + BildirilenEmirlerStr + "|";
                bool dahaOnceBildirildi = cacheStr.Contains(aramaPattern);

                if (!dahaOnceBildirildi)
                {
                    try
                    {
                        // FIX: TÃ¼m deÄŸerleri direkt string olarak al (format kullanma!)
                        string sembol = emir.Symbol.ToString();
                        string yon = emir.BuySell.ToString();
                        string fiyat = emir.Price.ToString(); // Format YOK!
                        string zaman = emir.OrderDate.ToString(); // Format YOK!
                        
                        // Miktar iÃ§in farklÄ± property dene
                        string miktar = "1";
                        try { miktar = emir.GerAmount.ToString(); } catch { }
                        try { miktar = emir.Amount.ToString(); } catch { }

                        string mesaj = "ğŸ”” <b>EMÄ°R GERÃ‡EKLEÅTÄ°</b>\n\n";
                        mesaj += "ğŸ”¹ <b>" + sembol + "</b>\n";
                        mesaj += "â–ªï¸ YÃ¶n: <b>" + yon + "</b>\n";
                        mesaj += "â–ªï¸ Miktar: <b>" + miktar + "</b>\n";
                        mesaj += "â–ªï¸ Fiyat: <b>" + fiyat + "</b>\n";
                        mesaj += "â–ªï¸ Zaman: " + zaman + "\n";
                        mesaj += "â–ªï¸ Emir No: " + emirId;

                        // Telegram GÃ¶nder
                        string url = "https://api.telegram.org/bot" + ApiToken + "/sendMessage?chat_id=" + ChatIdMain + "&text=" + System.Uri.EscapeDataString(mesaj) + "&parse_mode=HTML";
                        System.Net.WebRequest.Create(url).GetResponse().Close();

                        DosyayaYaz(DosyaDebug, Now + " SUCCESS: Emir bildirimi gonderildi: " + emirId + "\r\n", true);

                        // Cache'e ekle
                        if (BildirilenEmirlerStr.Length > 0) BildirilenEmirlerStr += "|";
                        BildirilenEmirlerStr += emirId;
                        yeniBildirimVar = true;
                    }
                    catch (Exception exEmir)
                    {
                        DosyayaYaz(DosyaDebug, Now + " ERROR Emir Bildirimi: " + exEmir.Message + "\r\n", true);
                    }
                }
            }
            
            if (yeniBildirimVar)
            {
                // String Ã§ok uzarsa eski emirleri temizle
                if (BildirilenEmirlerStr.Length > 5000)
                {
                    BildirilenEmirlerStr = BildirilenEmirlerStr.Substring(BildirilenEmirlerStr.Length - 4000);
                }
                Sistem.NesneKaydet(KeyBildirilenEmirler, BildirilenEmirlerStr);
            }
        }
    }
    catch (Exception ex)
    {
        DosyayaYaz(DosyaDebug, Now + " ERROR Emir Takip: " + ex.Message + "\r\n", true);
    }
}

// --- POZÄ°SYONLARI OKU ---
var Pozisyonlar = ViopHesap.Pozisyonlar;

// --- TELEGRAM RAPORU ---
var KeyLastTelegram = "ViopPozTakip_LastTelegram";
var LastTelegramObj = Sistem.NesneGetir(KeyLastTelegram);
DateTime LastTelegram = LastTelegramObj == null ? DateTime.MinValue : (DateTime)LastTelegramObj;

bool RaporZamaniGeldi = (Now - LastTelegram).TotalMinutes >= RaporGondermeAraligiDakika;

if (RaporZamaniGeldi && Pozisyonlar != null && Pozisyonlar.Count > 0)
{
    Sistem.NesneKaydet(KeyLastTelegram, Now);
    try
    {
        string mesaj = "ğŸ“Š <b>VIOP POZÄ°SYON RAPORU</b>\n\n";
        mesaj += "â° " + Now.ToString("HH:mm") + "\n";
        mesaj += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";

        mesaj += "ğŸ’° <b>HESAP BÄ°LGÄ°LERÄ°</b>\n";
        mesaj += "â”œ Toplam Teminat: " + ToplamTeminat.ToString("N0") + " TL\n";
        mesaj += "â”œ KullanÄ±labilir: " + KullanilabilirTeminat.ToString("N0") + " TL\n";
        mesaj += "â”” Ã‡ekilebilir: " + CekilebilirTeminat.ToString("N0") + " TL\n\n";

        mesaj += "ğŸ“ˆ <b>AÃ‡IK POZÄ°SYONLAR (" + Pozisyonlar.Count + ")</b>\n";
        mesaj += "<pre>";

        decimal toplamAnlikKZ = 0;
        for (int i = 0; i < Pozisyonlar.Count; i++)
        {
            var poz = Pozisyonlar[i];
            string sembol = poz.Symbol.Replace("VIP'VIP-", "").Replace("VIP'", "");
            double netMiktar = poz.NetAmount;
            decimal anlikKZ = poz.ProfitAnlik;
            string yon = netMiktar > 0 ? "L" : "S";

            mesaj += sembol.PadRight(10) + " " + yon + " " + Math.Abs(netMiktar).ToString("0").PadLeft(3) + " ";
            mesaj += (anlikKZ >= 0 ? "+" : "") + anlikKZ.ToString("0").PadLeft(6) + "â‚º\n";

            toplamAnlikKZ += anlikKZ;
        }
        mesaj += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        mesaj += "TOPLAM K/Z: " + (toplamAnlikKZ >= 0 ? "+" : "") + toplamAnlikKZ.ToString("N0") + "â‚º";
        mesaj += "</pre>\n\n";
        mesaj += "<i>" + RaporGondermeAraligiDakika + " dk gÃ¼ncellenir</i>";

        string url = "https://api.telegram.org/bot" + ApiToken + "/sendMessage?chat_id=" + ChatIdMain + "&text=" + System.Uri.EscapeDataString(mesaj) + "&parse_mode=HTML";
        System.Net.WebRequest.Create(url).GetResponse().Close();
    }
    catch (Exception ex)
    {
        DosyayaYaz(DosyaDebug, Now + " ERROR Telegram: " + ex.Message + "\r\n", true);
    }
}

return null;
